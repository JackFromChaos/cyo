<html>
<title>CYO - The Choose Your Own Adventure Framework</title>
<!-- <script src='lib/jquery/dist/jquery-2.0.3.js'></script> -->
<script src='lib/angular/angular.min.js'></script>
<script src='js/cyo.js'></script>


<body class='container' ng-app="cyo2">
    <h1>CYO2</h1>

    <story>
        <!-- {{choices}} -->
        <!-- {{storyEvents}} -->
        <page intro>
            Wow! What a great new format.
            <event story-started></event>
            <choice go>Time to go!</choice>
            <choice stay>Time to stay!</choice>
        </page>
        <page go>
            <!-- {{isComplete}} -->
            Ho ho! Now I go!
            <event went></event>
            <choice next-zone>The next zone?</choice>
        </page>
        <page stay>
            Hey hey! Think I'll stay!
            <choice next-zone>The next zone, then.</choice>
        </page>
        <page next-zone>
            You arrive in the next zone.
            <!-- <img src="http://i.imgur.com/FmUAOsH.jpg" width="500px"> -->
            <condition went>
                Glad I went.
            </condition>
            <choice unknown-place>... but what about the Unknown Place?</choice>
        </page>
    </story>


</body>
<script>
angular.module("cyo2", [])
    .directive("story", function() {
        return {
            restrict: "EA",
            controller: "StoryController",
        }
    })
    .directive("page", function() {
        return {
            restrict: "EA",
            scope: "&",
            controller: "PageController",
        }
    })
    .directive("event", function() {
        return {
            restrict: "EA",
            controller: "EventController",
        }
    })
    .directive("choice", function() {
        return {
            restrict: "EAC",
            scope: "=",
            controller: "ChoiceController",
        }
    })
    .directive("condition", function() {
        return {
            restrict: "EA",
            scope: "=",
            controller: "ConditionController",
        }
    })


.controller("StoryController", function($scope, $element) {
    $scope.storyEvents = {};
    $scope.pages = {};
    $scope.choices = {};

    $scope.decisions = {};

    $scope.registerPage = function(name, controller) {
        controller.hide();
    };

    $scope.$watch("pages", function() {
        for (var title in $scope.pages) {
            var page = $scope.pages[title];
            if (title == "intro") page.show();
        }
    });

    $scope.$watch("choices", function() {
        for (var choiceName in $scope.choices) {
            if (!$scope.pages[choiceName]) {
                console.warn("cant find page for,", choiceName);
            }
        }
    }, true);

    $scope.$watch("decisions", function() {

        for (var choiceName in $scope.decisions) {
            if (!$scope.pages[choiceName]) {
                $element.append("cant find this");
                return;
            }
            $scope.pages[choiceName].show();
        }
    }, true);
})

.controller("ConditionController", function($scope, $element, $attrs) {
    var condition = Object.keys($attrs.$attr);
    var isNegative = false;
    if (condition[0] === "unless" || condition[0] === "not") {
        isNegative = true;
        storyEvents.shift();
    };

    $scope.$watch("storyEvents", function() {
        console.log('an event happened', $scope.storyEvents);
    })

})

.controller("PageController", function($scope, $attrs, $element) {

    var pageName = Object.keys($attrs.$attr)[0];
    var events = $element.find('event').scope();

    $scope.pages[pageName] = this;

    this.show = function() {
        $element.attr("style", "display:block");
        // console.log("Showing",events);
        // events.forEach(function(_event){
          // console.log('activating,',_event);
            // _event.activate();
        // })
    };
    this.hide = function() {
        $element.attr("style", "display:none");
    };

    console.log();

    $scope.isComplete = false;


})

.controller("ChoiceController", function($scope, $attrs, $element) {
    var choiceName = Object.keys($attrs.$attr)[0];
    $scope.$parent.choices[choiceName] = choiceName;

    angular.element($element).on("click", function() {
        $scope.$parent.isComplete = true;
        $scope.$parent.decisions[choiceName] = choiceName;
        $scope.$apply();
    });

    $scope.$watch("isComplete", function() {
        if ($scope.isComplete) {
            console.log("I'm complete");
            $element.attr("style", "display:none");

        }
    }, true);
})

.controller("EventController", function($scope, $attrs) {
    var storyEvent = Object.keys($attrs.$attr);
    var isNegative = false;
    if (storyEvent[0] === "clear") {
        isNegative = true;
        storyEvent.shift();
    };

    this.isEvent = true;

    this.activate = function() {
      if (!isNegative) {
          $scope.storyEvents[storyEvent] = storyEvent;
      } else {
          delete $scope.storyEvents[storyEvent];
      }
    }

    

    // storyEventservice[(!isNegative) ? "add" : "remove"](storyEvents[0]);
})
</script>
<style>
page,
story,
choice {
    display: block;
    /*border: 1px solid black;*/
}
choice {
    display: block;
    border-style: solid;
    border-color: #bbb #888 #666 #aaa;
    border-width: 3px 4px 4px 3px;
    width: 9em;
    margin: 5px;
    height: 2em;
    background: #ccc;
    color: #333;
    line-height: 2;
    text-align: center;
    text-decoration: none;
    font-weight: 900;
    transition: 0.2s all;
    cursor: pointer;
}
choice:hover {
    /*border-color: #666 #aaa #bbb #888;*/
    /*border-width: 4px 3px 3px 4px;*/
    color: #000;
}
page {
    display: none;
}
page:first-child {
    display: block;
}
;
</style>

</html>
